<div dir="rtl" align="right">

# 🧩 אימות משתמשים מול ימות המשיח (API)

קובץ זה מיועד לניהול תהליך **אימות משתמשים דו־שלבי (MFA)** מול מערכת **ימות המשיח** באמצעות API, כולל טיפול בטוקן, שליחת קוד אימות ואימותו מול מקור חיצוני.

---

## ⚙️ מבנה כללי

המערכת מקבלת קריאה אחת לנתיב הראשי `/`, ובודקת לפי הנתונים שנשלחו מה בדיוק נדרש לבצע:

1. **אם נשלח טוקן בלבד:**
   - המערכת בודקת מול ימות האם הטוקן מאומת (`isPassInThisSession`).
   - אם הוא **מאומת** – מוחזר מיד ה־Token.
   - אם הוא **לא מאומת** – נעשה ניסיון לאמת את הטוקן באמצעות קוד אימות (דורש גם `mfaid`).

2. **אם נשלחו גם טוקן וגם שם משתמש/סיסמה:**
   - במידה והטוקן לא תקין או פג תוקף, מתבצע ניסיון לחדש את הטוקן באמצעות שם המשתמש והסיסמה.

3. **אם לא נשלח טוקן כלל:**
   - נדרש לשלוח שם משתמש (`num`), סיסמה (`pas`) ו־מזהה שיטת אימות (`mfaid`).
   - המערכת תבצע התחברות לימות לקבלת טוקן חדש.

---

## 🧠 שלבי הפעולה (Flow)

1. **קבלת פרמטרים מהקריאה:**
   - `num` – שם משתמש (בדרך כלל מספר משתמש).
   - `pas` – סיסמת המשתמש.
   - `token` – טוקן קיים, אם יש.
   - `mfaid` – מזהה שיטת האימות (ID של סוג ה־MFA).

2. **כניסה או חידוש טוקן:**
   - אם אין טוקן קיים, המערכת מבצעת קריאה ל־  
     `https://www.call2all.co.il/ym/api/Login?username={num}&password={pas}`  
     כדי לקבל טוקן חדש.

3. **בדיקת תקפות טוקן:**
   - המערכת פונה ל־  
     `MFASession?token={token}&action=isPass`
   - אם מוחזר `true`, המשתמש כבר מאומת → מוחזר הטוקן.

4. **שליחת קוד אימות (אם לא מאומת):**
   - קריאה ל־  
     `MFASession?token={token}&action=sendMFA&mfaId={mfaid}&mfaSendType=EMAIL`
   - מחכה לקבלת הקוד ממקור חיצוני (`GASURL`).

5. **קבלת קוד האימות:**
   - המערכת פונה לכתובת שהוגדרה במשתנה סביבה `GASURL`
   - מצפה לקבל קוד בן 6 ספרות (תוך 25 שניות).

6. **אימות הקוד מול ימות:**
   - קריאה ל־  
     `MFASession?token={token}&action=validMFA&mfaCode={code}`
   - אם מוחזר `"VALID"` – המשתמש מאומת בהצלחה.

---

## 📡 תגובות אפשריות

| מצב | תגובה |
|------|--------|
| התחברות והאימות הצליחו | מוחזר ה־Token |
| טוקן מאומת קיים מראש | מוחזר ה־Token |
| נשלח קוד אך עדיין לא התקבל | `CODE-NOT-YET-RECEIVED:{token}` |
| טוקן לא מאומת | `UNVERIFIED-TOKEN:{token}` |
| שגיאה בפרמטרים | מחרוזת ריקה |

---

## 🧩 פונקציות עזר

| שם הפונקציה | תפקיד |
|--------------|--------|
| `getToken()` | מקבל טוקן חדש מימות לפי שם וסיסמה |
| `getCheck()` | בודק האם המשתמש כבר מאומת |
| `getSend()` | שולח קוד אימות |
| `getCode()` | מקבל את הקוד ממקור חיצוני (GAS) |
| `getValid()` | מאמת את הקוד מול ימות |

---

## 🌐 משתני סביבה נדרשים

- `GASURL` — כתובת ה־URL שממנה נלקח קוד האימות (Google Apps Script או מקור אחר).

---

## 📤 דוגמת קריאה

### קריאה ראשונה (ללא טוקן):
```bash
GET /?num=12345&pas=abcd123&mfaid=6789
