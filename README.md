<div dir="rtl" align="right">

# 🧩 אימות משתמשים מול ימות המשיח (API)

קובץ זה מיועד לניהול תהליך **אימות משתמשים דו־שלבי (MFA)** מול מערכת **ימות המשיח** באמצעות API, כולל טיפול בטוקן, שליחת קוד אימות ואימותו מול מקור חיצוני.

---

## ⚙️ מבנה כללי

המערכת מקבלת קריאה אחת לנתיב הראשי `/`, ובודקת לפי הנתונים שנשלחו מה בדיוק נדרש לבצע:

1. **אם נשלח טוקן בלבד:**

   * המערכת בודקת מול ימות האם הטוקן מאומת (`isPassInThisSession`).
   * אם הוא **מאומת** – מוחזר מיד ה־Token.
   * אם הוא **לא מאומת** – נעשה ניסיון לאמת את הטוקן באמצעות קוד אימות **(דורש לקבל בקריאה גם פרמטר `mfaid`)**.

2. **אם נשלחו גם טוקן וגם שם משתמש/סיסמה:**

   * במידה והטוקן לא תקין או פג תוקף, מתבצע ניסיון לחדש את הטוקן באמצעות שם המשתמש והסיסמה.

3. **אם לא נשלח טוקן כלל:**

   * נדרש לשלוח שם משתמש (`num`), סיסמה (`pas`) ו־מזהה שיטת אימות (`mfaid`).
   * המערכת תבצע התחברות לימות לקבלת טוקן חדש.

---

## 🧠 שלבי הפעולה (Flow)

1. **קבלת פרמטרים מהקריאה:**

   * `num` – שם משתמש (בדרך כלל מספר מערכת).
   * `pas` – סיסמת המשתמש.
   * `token` – טוקן קיים, אם יש.
   * `mfaid` – מזהה שיטת האימות (ID של סוג ה־MFA).

2. **כניסה או חידוש טוקן:**

   * אם אין טוקן קיים, המערכת מבצעת קריאה ל־
     `Login?username={num}&password={pas}`
     כדי לקבל טוקן חדש.

3. **בדיקת תקפות טוקן:**

   * המערכת פונה ל־
     `MFASession?token={token}&action=isPass`
   * אם מוחזר `true`, המשתמש כבר מאומת → מוחזר הטוקן.

4. **שליחת קוד אימות (אם לא מאומת):**

   * קריאה ל־
     `MFASession?token={token}&action=sendMFA&mfaId={mfaid}&mfaSendType=EMAIL`
   * מחכה לקבלת הקוד ממקור חיצוני (`GASURL`).

5. **קבלת קוד האימות:**

   * המערכת פונה לכתובת שהוגדרה במשתנה סביבה `GASURL`
   * מצפה לקבל קוד בן 6 ספרות (תוך 25 שניות).

6. **אימות הקוד מול ימות:**

   * קריאה ל־
     `MFASession?token={token}&action=validMFA&mfaCode={code}`
   * אם מוחזר `"VALID"` – המשתמש מאומת בהצלחה.

---

## 📡 תגובות אפשריות

| מצב                        | תגובה                           |
| -------------------------- | ------------------------------- |
| התחברות והאימות הצליחו     | מוחזר ה־Token                   |
| טוקן מאומת קיים מראש       | מוחזר ה־Token                   |
| נשלח קוד אך עדיין לא התקבל | `CODE-NOT-YET-RECEIVED:{token}` |
| טוקן לא מאומת              | `UNVERIFIED-TOKEN:{token}`      |
| שגיאה בפרמטרים             | מחרוזת ריקה                     |

---

## 🧩 פונקציות עזר

| שם הפונקציה  | תפקיד                             |
| ------------ | --------------------------------- |
| `getToken()` | מקבל טוקן חדש מימות לפי שם וסיסמה |
| `getCheck()` | בודק האם המשתמש כבר מאומת         |
| `getSend()`  | שולח קוד אימות                    |
| `getCode()`  | מקבל את הקוד ממקור חיצוני (GAS)   |
| `getValid()` | מאמת את הקוד מול ימות             |

---

## 🌐 משתני סביבה נדרשים

* `GASURL` — כתובת ה־URL שממנה נלקח קוד האימות (Google Apps Script או מקור אחר).

---

## 📤 דוגמת קריאה

### קריאה ראשונה (ללא טוקן):

```bash
GET /?num=0777777777&pas=1234567&mfaid=2
```

### קריאה עם טוקן קיים:

```bash
GET /?token=xyz987&mfaid=2
```

### קריאה עם טוקן שאולי לא תקף:

```bash
GET /?token=xyz987&num=0777777777&pas=1234567&mfaid=2
```

---

## 🧱 שגיאות אפשריות

* CODE-NOT-YET-RECEIVED – הקוד עדיין לא הגיע מהמייל.
* UNVERIFIED-TOKEN – הקוד שנשלח לא אומת בהצלחה.
* ריק – שגיאה כללית או בעיית תקשורת.

---

## 🛠️ טכנולוגיות

* Flask – לניהול בקשות HTTP.
* Requests – לשליחת בקשות לימות ול־GAS.
* Python 3.x

---

## 📘 הוראות שימוש

לפני הפעלת השירות, יש לוודא שהוגדרו כל התנאים הדרושים להפעלה תקינה של תהליך האימות.

### 🧱 משתני סביבה

יש להגדיר משתנה סביבה בשם:

```nginx
GASURL
```

המשתנה צריך להכיל כתובת (URL) של שירות חיצוני (למשל Google Apps Script) שתפקידו לשלוף את קוד האימות מהמייל ולהחזיר אותו כטקסט נקי. הקוד אמור להיות בן 6 ספרות.

דוגמה למענה שהשירות צריך להחזיר:

```
763415
```

---

## 🚀 קריאה לשירות

הפנייה מתבצעת לנתיב הראשי של השרת (לדוגמה `https://yourapp.example.com/`) בשיטת GET, עם הפרמטרים הבאים:

| פרמטר | חובה        | תיאור                                          |
| ----- | ----------- | ---------------------------------------------- |
| num   | ✅           | שם המשתמש (לרוב מספר מערכת)                    |
| pas   | ✅           | סיסמת המשתמש                                   |
| mfaid | ✅           | מזהה שיטת האימות (בדוא"ל) |
| token | ⛔ אופציונלי | טוקן קיים, אם ברצונך לבדוק או לאמת אותו   |

### 🧩 דוגמאות שימוש

#### 📥 יצירת טוקן חדש ואימות ראשוני:

```bash
GET /?num=0777777777&pas=1234567&mfaid=2
```

#### 🔄 בדיקת טוקן קיים:

```bash
GET /?token=xyz987&mfaid=2
```

#### 🧠 שימוש משולב (בדיקת טוקן ויצירת חדש במידת הצורך):

```bash
GET /?token=xyz987&num=0777777777&pas=1234567&mfaid=2
```

---

## ⚙️ תהליך העבודה בקצרה

1. השירות מקבל את הנתונים (`num`, `pas`, `mfaid`, וייתכן גם `token`).
2. אם נשלח טוקן, נבדקת תקפותו מול ימות המשיח.

   * אם תקף → מוחזר ישירות.
   * אם לא תקף → נשלחת בקשה לאימות חדש.
3. אם לא נשלח טוקן כלל, מתבצעת התחברות עם שם משתמש וסיסמה לקבלת טוקן חדש.
4. נשלח קוד אימות למייל.
5. השירות שהוגדר ב־`GASURL` מחלץ את הקוד מהמייל ומחזיר אותו.
6. הקוד נשלח חזרה לימות לאימות סופי.
7. במידה והכול תקין — מוחזר הטוקן המאומת.

---

# 📤 פלט צפוי

| מצב              | פלט                           |
| ---------------- | ----------------------------- |
| אימות הצליח      | מוחזר הטוקן התקף              |
| הקוד עוד לא הגיע | CODE-NOT-YET-RECEIVED:{token} |
| טוקן לא אומת     | UNVERIFIED-TOKEN:{token}      |
| שגיאה בפרמטרים   | מחרוזת ריקה                   |



***

</div>

<div dir="rtl" align="right">

***


# 📝 סיכום תגובות

* **טוקן בלבד מוחזר:** הטוקן תקין ומאומת.
* **כלום מוחזר:** קרתה שגיאה; משהו השתבש בתהליך.
* **טוקן + הערה:** הטוקן תקין, אך לא מאומת. ההערה מסבירה את הסטטוס המדויק.

</div>
